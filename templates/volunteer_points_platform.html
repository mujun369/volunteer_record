<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¯å¦ç¦æˆé•¿åˆ›æ–°åœˆå¿—æ„¿è€…ç§¯åˆ†è®°å½•å¹³å°</title>
    <style>
        h1 {
            text-align: center;
        }

        /* è¡¨æ ¼æ ‡é¢˜æ ·å¼ */
        .table-title {
            text-align: left;
            color: #333;
            font-weight: bold;
            font-size: 18px;
            margin: 20px auto 15px auto;
            width: 80%;
        }

        .filter-container {
            /* æ–°å¢æ ·å¼ï¼Œè®¾ç½®å¤–è¾¹è·ä½¿å…¶ä¸è¡¨æ ¼ç¬¬ä¸€åˆ—å¯¹é½ */
            margin-left: 10%; 
            text-align: left; 
            margin-bottom: 20px;
        }
        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            border: 1px solid #ddd; /* è¡¨æ ¼å¤–è¾¹æ¡† */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            /* ç¡®ä¿æ¯ä¸ªå•å…ƒæ ¼éƒ½æœ‰å®Œæ•´è¾¹æ¡† */
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            box-sizing: border-box;
        }
        th {
            background-color: #f2f2f2;
            /* å‡è®¾è¡¨å¤´å­—ä½“å¤§å°ä¸º 16pxï¼Œå¯æ ¹æ®å®é™…è°ƒæ•´ */
            font-size: 16px; 
        }
        /* æ–°å¢æŒ‰é’®æ ·å¼ */
        .insert-btn {
            padding: 5px 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            margin: 2px;
        }
        .insert-btn:hover {
            background-color: #1976D2;
        }
        /* è°ƒå¤§çº¿ä¸‹æ´»åŠ¨ç›¸å…³æ–‡å­—çš„å­—ä½“å¤§å°ï¼Œä½¿å…¶ä¸è¡¨å¤´ä¸€è‡´ï¼Œå†è°ƒå¤§ä¸€å· */
        #activity-type option[value="offline"],
        #activity-type {
            font-size: 18px; /* è°ƒå¤§ä¸€å·å­—ä½“ */
        }
        /* å¦‚æœæ˜¯è¡¨æ ¼é‡Œçš„çº¿ä¸‹æ´»åŠ¨å†…å®¹ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ç±»ä¼¼è§„åˆ™ */
        /* å‡è®¾çº¿ä¸‹æ´»åŠ¨åŠ è½½åè¡¨æ ¼æœ‰ç‰¹å®šæ ·å¼æ ‡è¯† */
        .offline-activity-row td {
            font-size: 1.1em; 
        }
        /* ç¼©å°ç±»åˆ«åˆ—çš„ç­›é€‰æ¡†å®½åº¦ */
        #table-body select {
            width: 80%;
            box-sizing: border-box;
            border: none;
            font-size: 16px;
            outline: none;
        }
        /* å¯ç¼–è¾‘å•å…ƒæ ¼æ ·å¼ */
        td[contenteditable="true"] {
            min-height: 20px;
            background-color: #fafafa;
            transition: background-color 0.2s;
            border: 1px solid #ddd !important; /* å¼ºåˆ¶æ˜¾ç¤ºè¾¹æ¡† */
            box-sizing: border-box;
        }
        td[contenteditable="true"]:hover {
            background-color: #f0f0f0;
            border: 1px solid #ccc !important; /* æ‚¬åœæ—¶ç¨å¾®åŠ æ·±è¾¹æ¡† */
        }
        td[contenteditable="true"]:focus {
            background-color: #fff;
            border: 2px solid #2196F3 !important; /* ç„¦ç‚¹æ—¶ä½¿ç”¨è“è‰²è¾¹æ¡† */
            outline: none; /* ç§»é™¤é»˜è®¤outline */
        }
        /* ç¡®ä¿æ‰€æœ‰è¡¨æ ¼è¡Œé«˜åº¦ä¸€è‡´ */
        #table-body tr {
            height: 40px;
        }
        #table-body td {
            vertical-align: middle;
        }
        /* å¼ºåˆ¶æ‰€æœ‰è¡¨æ ¼å•å…ƒæ ¼æ˜¾ç¤ºè¾¹æ¡† */
        #volunteer-table td,
        #volunteer-table th {
            border: 1px solid #ddd !important;
            border-collapse: separate !important;
        }
        /* ç§»é™¤å¯èƒ½å†²çªçš„CSSé€‰æ‹©å™¨ï¼Œè®©JavaScriptè®¾ç½®çš„å†…è”æ ·å¼ç”Ÿæ•ˆ */
        /* åªä¿ç•™åŸºç¡€çš„è¡¨æ ¼æ ·å¼ */
        /* ç¡®ä¿å¯ç¼–è¾‘å•å…ƒæ ¼çš„è¾¹æ¡† */
        #table-body td[contenteditable="true"] {
            border: 1px solid #ddd !important;
        }
        /* æ–°å¢è¡¨æ ¼æ ·å¼ */
        #summary-table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        #summary-table th, #summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            border-right: 1px solid #ddd;
        }
        #summary-table th {
            background-color: #f2f2f2;
            font-size: 16px;
        }
        /* æ±‡æ€»è¡¨æ ¼åˆ—å®½è®¾ç½® */
        #summary-table th:nth-child(1), #summary-table td:nth-child(1) { width: 25%; } /* å¿—æ„¿è€…åå­— */
        #summary-table th:nth-child(2), #summary-table td:nth-child(2) { width: 15%; } /* ç§¯åˆ† */
        #summary-table th:nth-child(3), #summary-table td:nth-child(3) { width: 20%; } /* å·²ä½¿ç”¨ç§¯åˆ† */
        #summary-table th:nth-child(4), #summary-table td:nth-child(4) { width: 20%; } /* å·²å…‘æ¢è¯¾ç¨‹æ•°é‡ */
        #summary-table th:nth-child(5), #summary-table td:nth-child(5) { width: 20%; } /* å‰©ä½™ç§¯åˆ† */
        /* æ–°å¢æ»šåŠ¨æ¡æ ·å¼ */
        .scrollable-table-container {
            max-height: 200px;
            overflow-y: auto;
        }
        /* æ’åºç›¸å…³æ ·å¼ */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable:hover {
            background-color: #e8e8e8;
        }
        .sort-arrow {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
        }
        .sort-asc .sort-arrow {
            color: #2196F3;
        }
        .sort-desc .sort-arrow {
            color: #2196F3;
        }
        .sort-asc .sort-arrow::before {
            content: 'â†‘';
        }
        .sort-desc .sort-arrow::before {
            content: 'â†“';
        }
        .sort-asc .sort-arrow,
        .sort-desc .sort-arrow {
            font-weight: bold;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 400px;
            max-width: 600px;
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        .modal-content p {
            margin-bottom: 15px;
            color: #666;
            font-size: 16px;
        }

        #volunteer-name-input {
            width: 80%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            min-width: 80px;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #d32f2f;
        }

        .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }

        .confirm-btn:hover {
            background-color: #45a049;
        }

        /* æŸ¥è¯¢ç»“æœæ ·å¼ */
        #query-result-content {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .result-label {
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>æ–¯å¦ç¦æˆé•¿åˆ›æ–°åœˆå¿—æ„¿è€…ç§¯åˆ†è®°å½•å¹³å°</h1>
    <!-- ç¬¬ä¸€ä¸ªè¡¨æ ¼æ ‡é¢˜ -->
    <h2 class="table-title">ğŸ“‹ æ´»åŠ¨å¿—æ„¿è€…æƒ…å†µè¾“å…¥è¡¨</h2>

    <div class="filter-container">
        <select id="activity-type" onchange="updateTable()">
            <option value="online">çº¿ä¸Šç›´æ’­</option>
            <option value="offline">çº¿ä¸‹æ´»åŠ¨</option>
        </select>
    </div>
    <!-- åŸè¡¨æ ¼ -->
    <table id="volunteer-table">
        <thead>
            <tr>
                <th>æ´»åŠ¨æ—¶é—´ä¸åç§°</th>
                <th>ç±»åˆ«</th>
                <th>åå­—</th>
                <th>ç§¯åˆ†</th> <!-- ä¿®æ”¹ä¸ºç§¯åˆ† -->
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- è¡¨æ ¼è¡Œå°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
        </tbody>
    </table>

    <!-- ç¬¬äºŒä¸ªè¡¨æ ¼æ ‡é¢˜ -->
    <h2 class="table-title" style="margin-top: 30px;">ğŸ’³ å¿—æ„¿è€…ç§¯åˆ†ä½¿ç”¨æƒ…å†µè¾“å…¥è¡¨</h2>

    <!-- æ–°å¢ç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨æ ¼ -->
    <table id="usage-table">
        <thead>
            <tr>
                <th>å¿—æ„¿è€…åå­—</th>
                <th>å·²ä½¿ç”¨ç§¯åˆ†</th>
                <th>å…‘æ¢è¯¾ç¨‹æ•°é‡</th>
            </tr>
        </thead>
        <tbody id="usage-table-body">
            <!-- åˆå§‹ç©ºç™½è¡Œ -->
            <tr>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
            </tr>
        </tbody>
    </table>

    <!-- ä»…ä¿ç•™æäº¤æŒ‰é’®ï¼Œå¹¶æ·»åŠ æ¸…ç©ºæŒ‰é’®å’Œå¯¼å‡ºæŒ‰é’® -->
    <div style="margin-left: 10%; margin-top: 20px;">
        <button id="submit-btn" class="action-btn">æäº¤</button>
        <button id="clear-btn" class="action-btn">æ¸…ç©ºä¸Šè¡¨</button>
        <button id="export-activity-btn" class="action-btn export-btn">å¯¼å‡ºæ´»åŠ¨æ€»è§ˆè¡¨</button>
        <button id="export-summary-btn" class="action-btn export-btn">å¯¼å‡ºå¿—æ„¿è€…ç§¯åˆ†æ€»è¡¨</button>
        <button id="query-btn" class="action-btn export-btn">ç§¯åˆ†æƒ…å†µæŸ¥è¯¢</button>
    </div>

    <!-- ç§»åŠ¨æ±‡æ€»è¡¨æ ¼åˆ°æäº¤æŒ‰é’®ä¸‹æ–¹ -->
    <div class="scrollable-table-container">
        <table id="summary-table">
            <thead>
                <tr>
                    <th id="sort-name" class="sortable">å¿—æ„¿è€…åå­— <span class="sort-arrow">â†•</span></th>
                    <th id="sort-score" class="sortable">ç§¯åˆ† <span class="sort-arrow">â†•</span></th>
                    <th>å·²ä½¿ç”¨ç§¯åˆ†</th>
                    <th>å·²å…‘æ¢è¯¾ç¨‹æ•°é‡</th>
                    <th>å‰©ä½™ç§¯åˆ†</th>
                </tr>
            </thead>
            <tbody id="summary-table-body">
                <!-- è¡¨æ ¼è¡Œå°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
            </tbody>
        </table>
    </div>

    <!-- æŸ¥è¯¢å¼¹çª— -->
    <div id="query-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ç§¯åˆ†æƒ…å†µæŸ¥è¯¢</h3>
            <p>è¯·è¾“å…¥æŸ¥è¯¢å¿—æ„¿è€…åå­—ï¼š</p>
            <input type="text" id="volunteer-name-input" placeholder="è¯·è¾“å…¥å¿—æ„¿è€…åå­—" />
            <div class="modal-buttons">
                <button id="cancel-query-btn" class="modal-btn cancel-btn">å–æ¶ˆ</button>
                <button id="confirm-query-btn" class="modal-btn confirm-btn">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- æŸ¥è¯¢ç»“æœå¼¹çª— -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>æŸ¥è¯¢ç»“æœ</h3>
            <div id="query-result-content">
                <!-- æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="modal-buttons">
                <button id="close-result-btn" class="modal-btn confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // æ·»åŠ ä¸€ä¸ªç‰ˆæœ¬å˜é‡æˆ–æ—¶é—´æˆ³
        const VERSION = Date.now();
        const offlineCategories = ['æµ·æŠ¥', 'å®£å‘', 'ç­¾åˆ°', 'å†™ç¨¿', 'åœºåŠ¡'];
        const onlineCategories = ['æµ·æŠ¥', 'å®£å‘', 'ç›´æ’­åŠ©æ‰‹', 'å†™ç¨¿', 'è§†é¢‘å‰ªè¾‘'];
        let mergedCell = null;

        // æ’åºç›¸å…³å˜é‡
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let summaryDataCache = [];

        function updateTable() {
            const activityType = document.getElementById('activity-type').value;
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            categories.forEach((category, index) => {
                const newRow = tableBody.insertRow();

                if (index === 0) {
                    // ç¬¬ä¸€è¡Œï¼šåˆ›å»ºåˆå¹¶çš„æ´»åŠ¨æ—¶é—´å•å…ƒæ ¼
                    mergedCell = newRow.insertCell(0);
                    mergedCell.rowSpan = categories.length;
                    mergedCell.contentEditable = true;

                    // ç¬¬ä¸€è¡Œçš„ç±»åˆ«å•å…ƒæ ¼ç´¢å¼•ä¸º1
                    const categoryCell = newRow.insertCell(1);
                    const categorySelect = createCategorySelect(activityType);
                    categorySelect.value = category;
                    categoryCell.appendChild(categorySelect);

                    // ç¬¬ä¸€è¡Œçš„åå­—å•å…ƒæ ¼ç´¢å¼•ä¸º2
                    const nameCell = newRow.insertCell(2);
                    nameCell.contentEditable = true;
                    nameCell.textContent = '';
                    nameCell.style.minHeight = '20px';
                    nameCell.style.border = '1px solid #ddd';
                    nameCell.style.borderRight = '1px solid #ddd';
                    nameCell.style.borderBottom = '1px solid #ddd';

                    // ç¬¬ä¸€è¡Œçš„ç§¯åˆ†å•å…ƒæ ¼ç´¢å¼•ä¸º3
                    const scoreCell = newRow.insertCell(3);
                    scoreCell.contentEditable = true;
                    scoreCell.textContent = '';
                    scoreCell.style.minHeight = '20px';
                    scoreCell.style.border = '1px solid #ddd';
                    scoreCell.style.borderRight = '1px solid #ddd';
                    scoreCell.style.borderBottom = '1px solid #ddd';
                } else {
                    // åç»­è¡Œï¼šåˆ›å»ºéšè—çš„æ´»åŠ¨æ—¶é—´å•å…ƒæ ¼ï¼Œä¿æŒ4å•å…ƒæ ¼ç»“æ„ä¸€è‡´
                    const hiddenTimeCell = newRow.insertCell(0);
                    hiddenTimeCell.style.display = 'none';

                    // ç±»åˆ«å•å…ƒæ ¼ç´¢å¼•ä¸º1
                    const categoryCell = newRow.insertCell(1);
                    const categorySelect = createCategorySelect(activityType);
                    categorySelect.value = category;
                    categoryCell.appendChild(categorySelect);

                    // åå­—å•å…ƒæ ¼ç´¢å¼•ä¸º2
                    const nameCell = newRow.insertCell(2);
                    nameCell.contentEditable = true;
                    nameCell.textContent = '';
                    nameCell.style.minHeight = '20px';
                    nameCell.style.border = '1px solid #ddd';
                    nameCell.style.borderRight = '1px solid #ddd';
                    nameCell.style.borderBottom = '1px solid #ddd';

                    // ç§¯åˆ†å•å…ƒæ ¼ç´¢å¼•ä¸º3
                    const scoreCell = newRow.insertCell(3);
                    scoreCell.contentEditable = true;
                    scoreCell.textContent = '';
                    scoreCell.style.minHeight = '20px';
                    scoreCell.style.border = '1px solid #ddd';
                    scoreCell.style.borderRight = '1px solid #ddd';
                    scoreCell.style.borderBottom = '1px solid #ddd';
                }
            });

            // è°ƒè¯•åˆå§‹è¡¨æ ¼ç»“æ„
            console.log('ğŸ—ï¸ åˆå§‹è¡¨æ ¼åˆ›å»ºå®Œæˆ:', {
                totalRows: tableBody.rows.length,
                rowStructures: Array.from(tableBody.rows).map((row, index) => ({
                    rowIndex: index,
                    cellCount: row.cells.length,
                    cellTypes: Array.from(row.cells).map((cell, cellIndex) => ({
                        cellIndex: cellIndex,
                        hasSelect: !!cell.querySelector('select'),
                        isContentEditable: cell.contentEditable === 'true',
                        display: cell.style.display
                    }))
                }))
            });
        }

        function createCategorySelect(activityType) {
            const categorySelect = document.createElement('select');
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            return categorySelect;
        }

        function addRow(position = 'after', selectedCell = null) {
            const activityType = document.getElementById('activity-type').value;
            const tableBody = document.getElementById('table-body');
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            let newRow;
            let referenceRow = null;

            if (selectedCell) {
                const selectedRow = selectedCell.parentNode;
                const rowIndex = Array.from(tableBody.rows).indexOf(selectedRow);
                newRow = tableBody.insertRow(position === 'before' ? rowIndex : rowIndex + 1);
                referenceRow = selectedRow;
            } else {
                newRow = tableBody.insertRow();
                // å¦‚æœæ²¡æœ‰æŒ‡å®šä½ç½®ï¼Œä½¿ç”¨æœ€åä¸€è¡Œä½œä¸ºå‚è€ƒ
                if (tableBody.rows.length > 1) {
                    referenceRow = tableBody.rows[tableBody.rows.length - 2];
                }
            }

            // å¢åŠ åˆå¹¶å•å…ƒæ ¼çš„è¡Œè·¨åº¦
            if (mergedCell) {
                mergedCell.rowSpan++;
            }

            // åˆ›å»ºéšè—çš„æ´»åŠ¨æ—¶é—´å•å…ƒæ ¼ï¼ˆä¸åŸæœ‰è¡Œç»“æ„ä¿æŒä¸€è‡´ï¼‰
            const hiddenTimeCell = newRow.insertCell(0);
            hiddenTimeCell.style.display = 'none';

            // åˆ›å»ºç±»åˆ«å•å…ƒæ ¼ï¼ˆæ–°è¡Œçš„ç¬¬äºŒä¸ªå•å…ƒæ ¼ï¼Œå¯¹åº”è¡¨å¤´çš„ç¬¬äºŒåˆ—ï¼‰
            const categoryCell = newRow.insertCell(1);
            const categorySelect = createCategorySelect(activityType);

            // å¦‚æœæœ‰å‚è€ƒè¡Œï¼Œè®¾ç½®æ–°è¡Œçš„ç±»åˆ«ä¸å‚è€ƒè¡Œä¸€è‡´
            // ç°åœ¨æ‰€æœ‰è¡Œçš„ç±»åˆ«å•å…ƒæ ¼éƒ½åœ¨ç´¢å¼•1
            if (referenceRow && referenceRow.cells[1]) {
                const referenceSelect = referenceRow.cells[1].querySelector('select');
                if (referenceSelect) {
                    const referenceValue = referenceSelect.value;
                    categorySelect.value = referenceValue;
                }
            }

            categoryCell.appendChild(categorySelect);

            // åˆ›å»ºåå­—å•å…ƒæ ¼ï¼ˆæ–°è¡Œçš„ç¬¬ä¸‰ä¸ªå•å…ƒæ ¼ï¼Œå¯¹åº”è¡¨å¤´çš„ç¬¬ä¸‰åˆ—ï¼‰
            const nameCell = newRow.insertCell(2);
            nameCell.contentEditable = true;
            nameCell.textContent = ''; // ç¡®ä¿åå­—åˆ—ä¸ºç©º
            nameCell.style.minHeight = '20px'; // è®¾ç½®æœ€å°é«˜åº¦ä¾¿äºç‚¹å‡»
            nameCell.style.cursor = 'text';

            // åˆ›å»ºç§¯åˆ†å•å…ƒæ ¼ï¼ˆæ–°è¡Œçš„ç¬¬å››ä¸ªå•å…ƒæ ¼ï¼Œå¯¹åº”è¡¨å¤´çš„ç¬¬å››åˆ—ï¼‰
            const scoreCell = newRow.insertCell(3);
            scoreCell.contentEditable = true;
            scoreCell.textContent = ''; // ç¡®ä¿ç§¯åˆ†åˆ—ä¸ºç©º
            scoreCell.style.minHeight = '20px'; // è®¾ç½®æœ€å°é«˜åº¦ä¾¿äºç‚¹å‡»
            scoreCell.style.cursor = 'text';
            scoreCell.setAttribute('data-test', 'score-cell');

            // æš‚æ—¶ç¦ç”¨ç±»åˆ«åˆ—åˆå¹¶ï¼Œä¿æŒè¡¨æ ¼ç»“æ„ä¸€è‡´
            // TODO: å¦‚æœéœ€è¦åˆå¹¶åŠŸèƒ½ï¼Œå¯ä»¥åœ¨åç»­ä¼˜åŒ–
        }

        // ä¸ºè¡¨æ ¼å•å…ƒæ ¼æ·»åŠ å³é”®èœå•
        document.getElementById('volunteer-table').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const cell = e.target.closest('td');
            if (cell) {
                const insertAfterBtn = document.createElement('button');
                insertAfterBtn.className = 'insert-btn';
                insertAfterBtn.textContent = 'åœ¨ä¸‹ä¸€è¡Œæ’å…¥';
                insertAfterBtn.onclick = () => {
                    addRow('after', cell);
                };

                const deleteRowBtn = document.createElement('button');
                deleteRowBtn.className = 'insert-btn';
                deleteRowBtn.textContent = 'åˆ é™¤å½“å‰è¡Œ';
                deleteRowBtn.onclick = () => {
                    const row = cell.parentNode;
                    const tableBody = document.getElementById('table-body');
                    tableBody.removeChild(row);
                    if (mergedCell) {
                        mergedCell.rowSpan--;
                    }
                };

                const contextMenu = document.createElement('div');
                contextMenu.style.position = 'absolute';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.backgroundColor = 'white';
                contextMenu.style.border = '1px solid #ddd';
                contextMenu.style.padding = '5px';
                contextMenu.appendChild(insertAfterBtn);
                contextMenu.appendChild(deleteRowBtn);

                document.body.appendChild(contextMenu);

                const removeMenu = () => {
                    document.body.removeChild(contextMenu);
                    document.removeEventListener('click', removeMenu);
                };

                document.addEventListener('click', removeMenu);
            }
        });

        // ä¸ºç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨æ ¼æ·»åŠ å³é”®èœå•
        document.getElementById('usage-table').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const cell = e.target.closest('td');
            if (cell) {
                const insertAfterBtn = document.createElement('button');
                insertAfterBtn.className = 'insert-btn';
                insertAfterBtn.textContent = 'åœ¨ä¸‹ä¸€è¡Œæ’å…¥';
                insertAfterBtn.onclick = () => {
                    addUsageRow('after', cell);
                };

                const deleteRowBtn = document.createElement('button');
                deleteRowBtn.className = 'insert-btn';
                deleteRowBtn.textContent = 'åˆ é™¤å½“å‰è¡Œ';
                deleteRowBtn.onclick = () => {
                    const row = cell.parentNode;
                    const tableBody = document.getElementById('usage-table-body');
                    // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€è¡Œ
                    if (tableBody.rows.length > 1) {
                        tableBody.removeChild(row);
                    } else {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œï¼');
                    }
                };

                const contextMenu = document.createElement('div');
                contextMenu.style.position = 'absolute';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.backgroundColor = 'white';
                contextMenu.style.border = '1px solid #ddd';
                contextMenu.style.padding = '5px';
                contextMenu.style.zIndex = '1000';
                contextMenu.appendChild(insertAfterBtn);
                contextMenu.appendChild(deleteRowBtn);

                document.body.appendChild(contextMenu);

                const removeMenu = () => {
                    if (document.body.contains(contextMenu)) {
                        document.body.removeChild(contextMenu);
                    }
                    document.removeEventListener('click', removeMenu);
                };

                document.addEventListener('click', removeMenu);
            }
        });

        // æ·»åŠ ç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨æ ¼è¡Œçš„å‡½æ•°
        function addUsageRow(position = 'after', selectedCell = null) {
            const tableBody = document.getElementById('usage-table-body');
            let newRow;

            if (selectedCell) {
                const selectedRow = selectedCell.parentNode;
                const rowIndex = Array.from(tableBody.rows).indexOf(selectedRow);
                newRow = tableBody.insertRow(position === 'before' ? rowIndex : rowIndex + 1);
            } else {
                newRow = tableBody.insertRow();
            }

            // åˆ›å»ºä¸‰ä¸ªå¯ç¼–è¾‘å•å…ƒæ ¼
            for (let i = 0; i < 3; i++) {
                const cell = newRow.insertCell(i);
                cell.contentEditable = true;
                cell.style.minHeight = '20px';
                cell.style.cursor = 'text';
                cell.textContent = '';
            }
        }

        // æ’åºå‡½æ•°
        function sortSummaryData(column, direction) {
            const sortedData = [...summaryDataCache].sort((a, b) => {
                let valueA, valueB;

                if (column === 'name') {
                    valueA = a.name.toLowerCase();
                    valueB = b.name.toLowerCase();
                } else if (column === 'score') {
                    valueA = parseInt(a.total_score);
                    valueB = parseInt(b.total_score);
                }

                if (direction === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            renderSummaryTable(sortedData);
            updateSortIndicators(column, direction);
        }

        // æ¸²æŸ“æ±‡æ€»è¡¨æ ¼
        function renderSummaryTable(data) {
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            data.forEach(item => {
                const newRow = summaryTableBody.insertRow();

                // å¿—æ„¿è€…åå­—
                const nameCell = newRow.insertCell(0);
                nameCell.textContent = item.name;

                // æ€»ç§¯åˆ†
                const scoreCell = newRow.insertCell(1);
                scoreCell.textContent = item.total_score;

                // å·²ä½¿ç”¨ç§¯åˆ†
                const usedScoreCell = newRow.insertCell(2);
                usedScoreCell.contentEditable = true;
                usedScoreCell.textContent = '0'; // é»˜è®¤å·²ä½¿ç”¨ç§¯åˆ†ä¸º0

                // å·²å…‘æ¢è¯¾ç¨‹æ•°é‡
                const courseCountCell = newRow.insertCell(3);
                courseCountCell.textContent = '0'; // é»˜è®¤å·²å…‘æ¢è¯¾ç¨‹æ•°é‡ä¸º0

                // å‰©ä½™ç§¯åˆ†
                const remainingScoreCell = newRow.insertCell(4);
                remainingScoreCell.textContent = item.total_score; // åˆå§‹å‰©ä½™ç§¯åˆ†ç­‰äºæ€»ç§¯åˆ†

                // ä¸ºå·²ä½¿ç”¨ç§¯åˆ†å•å…ƒæ ¼æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨ï¼Œè‡ªåŠ¨è®¡ç®—å‰©ä½™ç§¯åˆ†
                usedScoreCell.addEventListener('input', function() {
                    updateRemainingScore(newRow);
                });
            });
        }

        // æ›´æ–°å‰©ä½™ç§¯åˆ†çš„å‡½æ•°
        function updateRemainingScore(row) {
            const totalScore = parseInt(row.cells[1].textContent) || 0; // æ€»ç§¯åˆ†
            const usedScore = parseInt(row.cells[2].textContent) || 0;  // å·²ä½¿ç”¨ç§¯åˆ†
            const remainingScore = totalScore - usedScore; // è®¡ç®—å‰©ä½™ç§¯åˆ†

            row.cells[4].textContent = remainingScore; // æ›´æ–°å‰©ä½™ç§¯åˆ†åˆ—
        }

        // ä»æ•°æ®åº“è·å–å¹¶åŒæ­¥ç§¯åˆ†ä½¿ç”¨æƒ…å†µåˆ°æ±‡æ€»è¡¨æ ¼
        function syncUsageDataFromDatabase() {
            fetch('/get_usage_summary', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(usageData => {
                const summaryTableBody = document.getElementById('summary-table-body');
                const summaryRows = summaryTableBody.rows;

                // éå†æ±‡æ€»è¡¨æ ¼çš„æ¯ä¸€è¡Œ
                for (let i = 0; i < summaryRows.length; i++) {
                    const summaryRow = summaryRows[i];
                    const volunteerName = summaryRow.cells[0].textContent.trim();

                    // åœ¨ä½¿ç”¨æ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¿—æ„¿è€…
                    const usageRecord = usageData.find(record => record.name === volunteerName);
                    if (usageRecord) {
                        // æ›´æ–°å·²ä½¿ç”¨ç§¯åˆ†åˆ—ï¼ˆæ˜¾ç¤ºç´¯åŠ åçš„ç»“æœï¼‰
                        summaryRow.cells[2].textContent = usageRecord.used_points || 0;

                        // æ›´æ–°å·²å…‘æ¢è¯¾ç¨‹æ•°é‡åˆ—ï¼ˆæ˜¾ç¤ºç´¯åŠ åçš„ç»“æœï¼‰
                        summaryRow.cells[3].textContent = usageRecord.course_count || 0;

                        // é‡æ–°è®¡ç®—å‰©ä½™ç§¯åˆ†
                        updateRemainingScore(summaryRow);
                    }
                }
            })
            .catch(error => {
                console.error('è·å–ç§¯åˆ†ä½¿ç”¨æƒ…å†µå¤±è´¥:', error);
            });
        }

        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicators(column, direction) {
            // æ¸…é™¤æ‰€æœ‰æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // æ·»åŠ å½“å‰æ’åºæŒ‡ç¤ºå™¨
            const targetHeader = document.getElementById(`sort-${column}`);
            if (targetHeader) {
                targetHeader.classList.add(`sort-${direction}`);
            }
        }

        // åŠ è½½æ±‡æ€»æ•°æ®çš„å‡½æ•°
        function loadSummaryData() {
            fetch('/get_summary', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(summaryData => {
                summaryDataCache = summaryData; // ç¼“å­˜æ•°æ®ç”¨äºæ’åº
                renderSummaryTable(summaryData);

                // åŠ è½½ç§¯åˆ†ä½¿ç”¨æƒ…å†µæ•°æ®
                syncUsageDataFromDatabase();
            })
            .catch(error => {
                console.error('åŠ è½½æ±‡æ€»æ•°æ®å¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¿æŒè¡¨æ ¼ä¸ºç©º
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¡¨æ ¼å’Œæ±‡æ€»æ•°æ®
        window.onload = function() {
            updateTable();
            loadSummaryData(); // åŠ è½½æ•°æ®åº“ä¸­çš„æ±‡æ€»æ•°æ®

            // æ·»åŠ æ’åºäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('sort-name').addEventListener('click', function() {
                const newDirection = (currentSortColumn === 'name' && currentSortDirection === 'asc') ? 'desc' : 'asc';
                currentSortColumn = 'name';
                currentSortDirection = newDirection;
                sortSummaryData('name', newDirection);
            });

            document.getElementById('sort-score').addEventListener('click', function() {
                const newDirection = (currentSortColumn === 'score' && currentSortDirection === 'asc') ? 'desc' : 'asc';
                currentSortColumn = 'score';
                currentSortDirection = newDirection;
                sortSummaryData('score', newDirection);
            });
        };

        // æ–°å¢æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .action-btn {
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 16px;
                margin-right: 10px;
            }
            .action-btn:hover {
                background-color: #45a049;
            }
            .export-btn {
                background-color: #2196F3;
            }
            .export-btn:hover {
                background-color: #1976D2;
            }
        `;
        document.head.appendChild(style);

        // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä¿®æ”¹åï¼Œç§»é™¤æç¤ºçª—å£ï¼‰
        // æ–°å¢æ¸…ç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('clear-btn').addEventListener('click', function() {
            // æ¸…ç©ºç¬¬ä¸€ä¸ªè¡¨æ ¼
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            const activityType = document.getElementById('activity-type').value;
            updateTable(); // é‡æ–°åˆå§‹åŒ–è¡¨æ ¼

            // æ¸…ç©ºç¬¬äºŒä¸ªè¡¨æ ¼ï¼ˆç§¯åˆ†ä½¿ç”¨è®°å½•è¡¨æ ¼ï¼‰
            const usageTableBody = document.getElementById('usage-table-body');
            usageTableBody.innerHTML = '';

            // é‡æ–°æ·»åŠ ä¸€ä¸ªç©ºç™½è¡Œ
            const newRow = usageTableBody.insertRow();
            for (let i = 0; i < 3; i++) {
                const cell = newRow.insertCell(i);
                cell.contentEditable = true;
                cell.style.minHeight = '20px';
                cell.style.cursor = 'text';
                cell.textContent = '';
            }
        });

        // å¯¼å‡ºæ´»åŠ¨æ€»è§ˆè¡¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('export-activity-btn').addEventListener('click', function() {
            const exportBtn = document.getElementById('export-activity-btn');
            const originalText = exportBtn.textContent;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            exportBtn.textContent = 'å¯¼å‡ºä¸­...';
            exportBtn.disabled = true;

            // è°ƒç”¨åç«¯å¯¼å‡ºæ¥å£
            fetch('/export_db', {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'volunteer_activity_overview_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('æ´»åŠ¨æ€»è§ˆè¡¨å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°ã€‚');
            })
            .catch(error => {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            });
        });

        // å¯¼å‡ºå¿—æ„¿è€…ç§¯åˆ†æ€»è¡¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('export-summary-btn').addEventListener('click', function() {
            const exportBtn = document.getElementById('export-summary-btn');
            const originalText = exportBtn.textContent;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            exportBtn.textContent = 'å¯¼å‡ºä¸­...';
            exportBtn.disabled = true;

            // è°ƒç”¨åç«¯å¯¼å‡ºå¿—æ„¿è€…ç§¯åˆ†æ€»è¡¨æ¥å£
            fetch('/export_volunteer_summary', {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'volunteer_points_summary_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('å¿—æ„¿è€…ç§¯åˆ†æ€»è¡¨å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°ã€‚');
            })
            .catch(error => {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            });
        });

        // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä¿®æ”¹åï¼Œåˆå¹¶é‡å¤åå­—å¹¶ç´¯åŠ ç§¯åˆ†ï¼Œå¹¶æäº¤åˆ°åç«¯ï¼‰
        document.getElementById('submit-btn').addEventListener('click', function() {
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.textContent = 'æäº¤ä¸­...';
            submitBtn.disabled = true;

            // è·å–æ´»åŠ¨æ—¶é—´ä¸åç§°
            const mergedCell = document.querySelector('#table-body tr:first-child td[rowspan]');

            // æ”¶é›†æ´»åŠ¨æ•°æ®ï¼ˆç¬¬ä¸€ä¸ªè¡¨æ ¼ï¼‰
            const activityData = [];
            const rows = document.getElementById('table-body').rows;
            const activityTimeName = mergedCell ? mergedCell.textContent.trim() : '';
            const activityTypeValue = document.getElementById('activity-type').value; // è·å–æ´»åŠ¨ç±»å‹å€¼

            // å°†è‹±æ–‡å€¼è½¬æ¢ä¸ºä¸­æ–‡
            const activityType = activityTypeValue === 'offline' ? 'çº¿ä¸‹æ´»åŠ¨' : 'çº¿ä¸Šç›´æ’­';

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];

                // ç°åœ¨æ‰€æœ‰è¡Œéƒ½æœ‰4ä¸ªå•å…ƒæ ¼ï¼š[æ´»åŠ¨æ—¶é—´(ç¬¬ä¸€è¡Œå¯è§ï¼Œå…¶ä»–è¡Œéšè—), ç±»åˆ«, åå­—, ç§¯åˆ†]
                if (row.cells.length === 4) {
                    const categorySelect = row.cells[1].querySelector('select');
                    const category = categorySelect ? categorySelect.value : '';
                    const name = row.cells[2].textContent.trim();
                    const score = row.cells[3].textContent.trim();

                    if (name && score && category) {
                        const scoreValue = parseInt(score, 10);
                        if (!isNaN(scoreValue)) {
                            // æ–°æ ¼å¼ï¼š[activity_type, activity_time_name, category, name, score]
                            activityData.push([activityType, activityTimeName, category, name, scoreValue.toString()]);
                        }
                    }
                } else {
                    // è·³è¿‡æ— æ•ˆè¡Œ
                    continue;
                }
            }

            // æ”¶é›†ç§¯åˆ†ä½¿ç”¨æ•°æ®ï¼ˆç¬¬äºŒä¸ªè¡¨æ ¼ï¼‰
            const usageData = [];
            const usageRows = document.getElementById('usage-table-body').rows;

            for (let i = 0; i < usageRows.length; i++) {
                const row = usageRows[i];
                if (row.cells.length === 3) {
                    const name = row.cells[0].textContent.trim();
                    const usedPoints = row.cells[1].textContent.trim();
                    const courseCount = row.cells[2].textContent.trim();

                    if (name && usedPoints && courseCount) {
                        usageData.push([name, usedPoints, courseCount]);
                    }
                }
            }

            if (activityData.length === 0 && usageData.length === 0) {
                alert('è¯·å…ˆè¾“å…¥æ•°æ®ï¼');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }

            // å‘é€æ•°æ®åˆ°åç«¯
            fetch('/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    activityData: activityData,
                    usageData: usageData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                }

                // æäº¤æˆåŠŸåï¼Œä»æ•°æ®åº“è·å–æ±‡æ€»æ•°æ®
                return fetch('/get_summary', {
                    method: 'GET',
                });
            })
            .then(response => response.json())
            .then(summaryData => {
                summaryDataCache = summaryData; // æ›´æ–°ç¼“å­˜æ•°æ®
                renderSummaryTable(summaryData);

                // ä»æ•°æ®åº“è·å–ç´¯åŠ åçš„ç§¯åˆ†ä½¿ç”¨æƒ…å†µå¹¶åŒæ­¥åˆ°æ±‡æ€»è¡¨æ ¼
                syncUsageDataFromDatabase();

                // å¦‚æœä¹‹å‰æœ‰æ’åºï¼Œä¿æŒæ’åºçŠ¶æ€
                if (currentSortColumn) {
                    sortSummaryData(currentSortColumn, currentSortDirection);
                }
            })
            .catch(error => {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // ç§¯åˆ†æƒ…å†µæŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('query-btn').addEventListener('click', function() {
            document.getElementById('query-modal').style.display = 'flex';
            document.getElementById('volunteer-name-input').value = '';
            document.getElementById('volunteer-name-input').focus();
        });

        // å–æ¶ˆæŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('cancel-query-btn').addEventListener('click', function() {
            document.getElementById('query-modal').style.display = 'none';
        });

        // ç¡®è®¤æŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('confirm-query-btn').addEventListener('click', function() {
            const volunteerName = document.getElementById('volunteer-name-input').value.trim();

            if (!volunteerName) {
                alert('è¯·è¾“å…¥å¿—æ„¿è€…åå­—ï¼');
                return;
            }

            // åœ¨æ±‡æ€»è¡¨æ ¼ä¸­æŸ¥æ‰¾å¿—æ„¿è€…ä¿¡æ¯
            const summaryTableBody = document.getElementById('summary-table-body');
            const summaryRows = summaryTableBody.rows;
            let foundVolunteer = null;

            for (let i = 0; i < summaryRows.length; i++) {
                const row = summaryRows[i];
                const name = row.cells[0].textContent.trim();

                if (name === volunteerName) {
                    foundVolunteer = {
                        name: name,
                        totalScore: row.cells[1].textContent.trim(),
                        usedScore: row.cells[2].textContent.trim(),
                        courseCount: row.cells[3].textContent.trim(),
                        remainingScore: row.cells[4].textContent.trim()
                    };
                    break;
                }
            }

            // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
            showQueryResult(foundVolunteer);

            // å…³é—­æŸ¥è¯¢å¼¹çª—
            document.getElementById('query-modal').style.display = 'none';
        });

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœçš„å‡½æ•°
        function showQueryResult(volunteer) {
            const resultContent = document.getElementById('query-result-content');

            if (volunteer) {
                resultContent.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">å¿—æ„¿è€…åå­—ï¼š</span>${volunteer.name}
                    </div>
                    <div class="result-item">
                        <span class="result-label">æ€»ç§¯åˆ†ï¼š</span>${volunteer.totalScore}
                    </div>
                    <div class="result-item">
                        <span class="result-label">å·²ä½¿ç”¨ç§¯åˆ†ï¼š</span>${volunteer.usedScore}
                    </div>
                    <div class="result-item">
                        <span class="result-label">å·²å…‘æ¢è¯¾ç¨‹æ•°é‡ï¼š</span>${volunteer.courseCount}
                    </div>
                    <div class="result-item">
                        <span class="result-label">å‰©ä½™ç§¯åˆ†ï¼š</span>${volunteer.remainingScore}
                    </div>
                `;
            } else {
                resultContent.innerHTML = `
                    <div class="result-item" style="text-align: center; color: #f44336;">
                        æœªæ‰¾åˆ°è¯¥å¿—æ„¿è€…çš„ç§¯åˆ†ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥åå­—æ˜¯å¦æ­£ç¡®ã€‚
                    </div>
                `;
            }

            document.getElementById('result-modal').style.display = 'flex';
        }

        // å…³é—­æŸ¥è¯¢ç»“æœå¼¹çª—
        document.getElementById('close-result-btn').addEventListener('click', function() {
            document.getElementById('result-modal').style.display = 'none';
        });

        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­å¼¹çª—
        document.getElementById('query-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('result-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // æ”¯æŒå›è½¦é”®ç¡®è®¤æŸ¥è¯¢
        document.getElementById('volunteer-name-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('confirm-query-btn').click();
            }
        });
    </script>
</body>
</html>
