<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斯坦福成长创新圈志愿者积分记录平台</title>
    <style>
        h1 {
            text-align: center;
        }

        /* 表格标题样式 */
        .table-title {
            text-align: left;
            color: #333;
            font-weight: bold;
            font-size: 18px;
            margin: 20px auto 15px auto;
            width: 80%;
        }

        .filter-container {
            /* 新增样式，设置外边距使其与表格第一列对齐 */
            margin-left: 10%; 
            text-align: left; 
            margin-bottom: 20px;
        }
        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            border: 1px solid #ddd; /* 表格外边框 */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            /* 确保每个单元格都有完整边框 */
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            box-sizing: border-box;
        }
        th {
            background-color: #f2f2f2;
            /* 假设表头字体大小为 16px，可根据实际调整 */
            font-size: 16px; 
        }
        /* 新增按钮样式 */
        .insert-btn {
            padding: 5px 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            margin: 2px;
        }
        .insert-btn:hover {
            background-color: #1976D2;
        }
        /* 调大线下活动相关文字的字体大小，使其与表头一致，再调大一号 */
        #activity-type option[value="offline"],
        #activity-type {
            font-size: 18px; /* 调大一号字体 */
        }
        /* 如果是表格里的线下活动内容，也可以添加类似规则 */
        /* 假设线下活动加载后表格有特定样式标识 */
        .offline-activity-row td {
            font-size: 1.1em; 
        }
        /* 缩小类别列的筛选框宽度 */
        #table-body select {
            width: 80%;
            box-sizing: border-box;
            border: none;
            font-size: 16px;
            outline: none;
        }
        /* 可编辑单元格样式 */
        td[contenteditable="true"] {
            min-height: 20px;
            background-color: #fafafa;
            transition: background-color 0.2s;
            border: 1px solid #ddd !important; /* 强制显示边框 */
            box-sizing: border-box;
        }
        td[contenteditable="true"]:hover {
            background-color: #f0f0f0;
            border: 1px solid #ccc !important; /* 悬停时稍微加深边框 */
        }
        td[contenteditable="true"]:focus {
            background-color: #fff;
            border: 2px solid #2196F3 !important; /* 焦点时使用蓝色边框 */
            outline: none; /* 移除默认outline */
        }
        /* 确保所有表格行高度一致 */
        #table-body tr {
            height: 40px;
        }
        #table-body td {
            vertical-align: middle;
        }
        /* 强制所有表格单元格显示边框 */
        #volunteer-table td,
        #volunteer-table th {
            border: 1px solid #ddd !important;
            border-collapse: separate !important;
        }
        /* 移除可能冲突的CSS选择器，让JavaScript设置的内联样式生效 */
        /* 只保留基础的表格样式 */
        /* 确保可编辑单元格的边框 */
        #table-body td[contenteditable="true"] {
            border: 1px solid #ddd !important;
        }
        /* 新增表格样式 */
        #summary-table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        #summary-table th, #summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            border-right: 1px solid #ddd;
        }
        #summary-table th {
            background-color: #f2f2f2;
            font-size: 16px;
        }
        /* 汇总表格列宽设置 */
        #summary-table th:nth-child(1), #summary-table td:nth-child(1) { width: 25%; } /* 志愿者名字 */
        #summary-table th:nth-child(2), #summary-table td:nth-child(2) { width: 15%; } /* 积分 */
        #summary-table th:nth-child(3), #summary-table td:nth-child(3) { width: 20%; } /* 已使用积分 */
        #summary-table th:nth-child(4), #summary-table td:nth-child(4) { width: 20%; } /* 已兑换课程数量 */
        #summary-table th:nth-child(5), #summary-table td:nth-child(5) { width: 20%; } /* 剩余积分 */
        /* 新增滚动条样式 */
        .scrollable-table-container {
            max-height: 200px;
            overflow-y: auto;
        }
        /* 排序相关样式 */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable:hover {
            background-color: #e8e8e8;
        }
        .sort-arrow {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
        }
        .sort-asc .sort-arrow {
            color: #2196F3;
        }
        .sort-desc .sort-arrow {
            color: #2196F3;
        }
        .sort-asc .sort-arrow::before {
            content: '↑';
        }
        .sort-desc .sort-arrow::before {
            content: '↓';
        }
        .sort-asc .sort-arrow,
        .sort-desc .sort-arrow {
            font-weight: bold;
        }

        /* 弹窗样式 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 400px;
            max-width: 600px;
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        .modal-content p {
            margin-bottom: 15px;
            color: #666;
            font-size: 16px;
        }

        #volunteer-name-input {
            width: 80%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            min-width: 80px;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background-color: #d32f2f;
        }

        .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }

        .confirm-btn:hover {
            background-color: #45a049;
        }

        /* 查询结果样式 */
        #query-result-content {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .result-label {
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>斯坦福成长创新圈志愿者积分记录平台</h1>
    <!-- 第一个表格标题 -->
    <h2 class="table-title">📋 活动志愿者情况输入表</h2>

    <div class="filter-container">
        <select id="activity-type" onchange="updateTable()">
            <option value="online">线上直播</option>
            <option value="offline">线下活动</option>
        </select>
    </div>
    <!-- 原表格 -->
    <table id="volunteer-table">
        <thead>
            <tr>
                <th>活动时间与名称</th>
                <th>类别</th>
                <th>名字</th>
                <th>积分</th> <!-- 修改为积分 -->
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- 表格行将通过 JavaScript 动态添加 -->
        </tbody>
    </table>

    <!-- 第二个表格标题 -->
    <h2 class="table-title" style="margin-top: 30px;">💳 志愿者积分使用情况输入表</h2>

    <!-- 新增积分使用记录表格 -->
    <table id="usage-table">
        <thead>
            <tr>
                <th>志愿者名字</th>
                <th>已使用积分</th>
                <th>兑换课程数量</th>
            </tr>
        </thead>
        <tbody id="usage-table-body">
            <!-- 初始空白行 -->
            <tr>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
                <td contenteditable="true" style="min-height: 20px; cursor: text;"></td>
            </tr>
        </tbody>
    </table>

    <!-- 仅保留提交按钮，并添加清空按钮和导出按钮 -->
    <div style="margin-left: 10%; margin-top: 20px;">
        <button id="submit-btn" class="action-btn">提交</button>
        <button id="clear-btn" class="action-btn">清空上表</button>
        <button id="export-activity-btn" class="action-btn export-btn">导出活动总览表</button>
        <button id="export-summary-btn" class="action-btn export-btn">导出志愿者积分总表</button>
        <button id="query-btn" class="action-btn export-btn">积分情况查询</button>
    </div>

    <!-- 移动汇总表格到提交按钮下方 -->
    <div class="scrollable-table-container">
        <table id="summary-table">
            <thead>
                <tr>
                    <th id="sort-name" class="sortable">志愿者名字 <span class="sort-arrow">↕</span></th>
                    <th id="sort-score" class="sortable">积分 <span class="sort-arrow">↕</span></th>
                    <th>已使用积分</th>
                    <th>已兑换课程数量</th>
                    <th>剩余积分</th>
                </tr>
            </thead>
            <tbody id="summary-table-body">
                <!-- 表格行将通过 JavaScript 动态添加 -->
            </tbody>
        </table>
    </div>

    <!-- 查询弹窗 -->
    <div id="query-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>积分情况查询</h3>
            <p>请输入查询志愿者名字：</p>
            <input type="text" id="volunteer-name-input" placeholder="请输入志愿者名字" />
            <div class="modal-buttons">
                <button id="cancel-query-btn" class="modal-btn cancel-btn">取消</button>
                <button id="confirm-query-btn" class="modal-btn confirm-btn">确认</button>
            </div>
        </div>
    </div>

    <!-- 查询结果弹窗 -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>查询结果</h3>
            <div id="query-result-content">
                <!-- 查询结果将在这里显示 -->
            </div>
            <div class="modal-buttons">
                <button id="close-result-btn" class="modal-btn confirm-btn">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 检测环境并设置API基础URL
        function getApiBaseUrl() {
            const hostname = window.location.hostname;

            // 本地开发环境
            if (hostname.includes('localhost') || hostname.includes('127.0.0.1')) {
                return '';
            }

            // GitHub Pages环境 - 始终指向Vercel后端
            if (hostname.includes('github.io')) {
                return 'https://volunteer-record.vercel.app';
            }

            // Vercel环境或其他生产环境
            return '';
        }

        const API_BASE_URL = getApiBaseUrl();
        const offlineCategories = ['海报', '宣发', '签到', '写稿', '场务'];
        const onlineCategories = ['海报', '宣发', '直播助手', '写稿', '视频剪辑'];
        let mergedCell = null;

        // 排序相关变量
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let summaryDataCache = [];

        function updateTable() {
            const activityType = document.getElementById('activity-type').value;
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // 清空表格内容
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            categories.forEach((category, index) => {
                const newRow = tableBody.insertRow();

                if (index === 0) {
                    // 第一行：创建合并的活动时间单元格
                    mergedCell = newRow.insertCell(0);
                    mergedCell.rowSpan = categories.length;
                    mergedCell.contentEditable = true;

                    // 第一行的类别单元格索引为1
                    const categoryCell = newRow.insertCell(1);
                    const categorySelect = createCategorySelect(activityType);
                    categorySelect.value = category;
                    categoryCell.appendChild(categorySelect);

                    // 第一行的名字单元格索引为2
                    const nameCell = newRow.insertCell(2);
                    nameCell.contentEditable = true;
                    nameCell.textContent = '';
                    nameCell.style.minHeight = '20px';
                    nameCell.style.border = '1px solid #ddd';
                    nameCell.style.borderRight = '1px solid #ddd';
                    nameCell.style.borderBottom = '1px solid #ddd';

                    // 第一行的积分单元格索引为3
                    const scoreCell = newRow.insertCell(3);
                    scoreCell.contentEditable = true;
                    scoreCell.textContent = '';
                    scoreCell.style.minHeight = '20px';
                    scoreCell.style.border = '1px solid #ddd';
                    scoreCell.style.borderRight = '1px solid #ddd';
                    scoreCell.style.borderBottom = '1px solid #ddd';
                } else {
                    // 后续行：创建隐藏的活动时间单元格，保持4单元格结构一致
                    const hiddenTimeCell = newRow.insertCell(0);
                    hiddenTimeCell.style.display = 'none';

                    // 类别单元格索引为1
                    const categoryCell = newRow.insertCell(1);
                    const categorySelect = createCategorySelect(activityType);
                    categorySelect.value = category;
                    categoryCell.appendChild(categorySelect);

                    // 名字单元格索引为2
                    const nameCell = newRow.insertCell(2);
                    nameCell.contentEditable = true;
                    nameCell.textContent = '';
                    nameCell.style.minHeight = '20px';
                    nameCell.style.border = '1px solid #ddd';
                    nameCell.style.borderRight = '1px solid #ddd';
                    nameCell.style.borderBottom = '1px solid #ddd';

                    // 积分单元格索引为3
                    const scoreCell = newRow.insertCell(3);
                    scoreCell.contentEditable = true;
                    scoreCell.textContent = '';
                    scoreCell.style.minHeight = '20px';
                    scoreCell.style.border = '1px solid #ddd';
                    scoreCell.style.borderRight = '1px solid #ddd';
                    scoreCell.style.borderBottom = '1px solid #ddd';
                }
            });


        }

        function createCategorySelect(activityType) {
            const categorySelect = document.createElement('select');
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            return categorySelect;
        }

        function addRow(position = 'after', selectedCell = null) {
            const activityType = document.getElementById('activity-type').value;
            const tableBody = document.getElementById('table-body');
            const categories = activityType === 'offline' ? offlineCategories : onlineCategories;
            let newRow;
            let referenceRow = null;

            if (selectedCell) {
                const selectedRow = selectedCell.parentNode;
                const rowIndex = Array.from(tableBody.rows).indexOf(selectedRow);
                newRow = tableBody.insertRow(position === 'before' ? rowIndex : rowIndex + 1);
                referenceRow = selectedRow;
            } else {
                newRow = tableBody.insertRow();
                // 如果没有指定位置，使用最后一行作为参考
                if (tableBody.rows.length > 1) {
                    referenceRow = tableBody.rows[tableBody.rows.length - 2];
                }
            }

            // 增加合并单元格的行跨度
            if (mergedCell) {
                mergedCell.rowSpan++;
            }

            // 创建隐藏的活动时间单元格（与原有行结构保持一致）
            const hiddenTimeCell = newRow.insertCell(0);
            hiddenTimeCell.style.display = 'none';

            // 创建类别单元格（新行的第二个单元格，对应表头的第二列）
            const categoryCell = newRow.insertCell(1);
            const categorySelect = createCategorySelect(activityType);

            // 如果有参考行，设置新行的类别与参考行一致
            // 现在所有行的类别单元格都在索引1
            if (referenceRow && referenceRow.cells[1]) {
                const referenceSelect = referenceRow.cells[1].querySelector('select');
                if (referenceSelect) {
                    const referenceValue = referenceSelect.value;
                    categorySelect.value = referenceValue;
                }
            }

            categoryCell.appendChild(categorySelect);

            // 创建名字单元格（新行的第三个单元格，对应表头的第三列）
            const nameCell = newRow.insertCell(2);
            nameCell.contentEditable = true;
            nameCell.textContent = ''; // 确保名字列为空
            nameCell.style.minHeight = '20px'; // 设置最小高度便于点击
            nameCell.style.cursor = 'text';

            // 创建积分单元格（新行的第四个单元格，对应表头的第四列）
            const scoreCell = newRow.insertCell(3);
            scoreCell.contentEditable = true;
            scoreCell.textContent = ''; // 确保积分列为空
            scoreCell.style.minHeight = '20px'; // 设置最小高度便于点击
            scoreCell.style.cursor = 'text';


            // 暂时禁用类别列合并，保持表格结构一致
            // TODO: 如果需要合并功能，可以在后续优化
        }

        // 为表格单元格添加右键菜单
        document.getElementById('volunteer-table').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const cell = e.target.closest('td');
            if (cell) {
                const insertAfterBtn = document.createElement('button');
                insertAfterBtn.className = 'insert-btn';
                insertAfterBtn.textContent = '在下一行插入';
                insertAfterBtn.onclick = () => {
                    addRow('after', cell);
                };

                const deleteRowBtn = document.createElement('button');
                deleteRowBtn.className = 'insert-btn';
                deleteRowBtn.textContent = '删除当前行';
                deleteRowBtn.onclick = () => {
                    const row = cell.parentNode;
                    const tableBody = document.getElementById('table-body');
                    tableBody.removeChild(row);
                    if (mergedCell) {
                        mergedCell.rowSpan--;
                    }
                };

                const contextMenu = document.createElement('div');
                contextMenu.style.position = 'absolute';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.backgroundColor = 'white';
                contextMenu.style.border = '1px solid #ddd';
                contextMenu.style.padding = '5px';
                contextMenu.appendChild(insertAfterBtn);
                contextMenu.appendChild(deleteRowBtn);

                document.body.appendChild(contextMenu);

                const removeMenu = () => {
                    document.body.removeChild(contextMenu);
                    document.removeEventListener('click', removeMenu);
                };

                document.addEventListener('click', removeMenu);
            }
        });

        // 为积分使用记录表格添加右键菜单
        document.getElementById('usage-table').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const cell = e.target.closest('td');
            if (cell) {
                const insertAfterBtn = document.createElement('button');
                insertAfterBtn.className = 'insert-btn';
                insertAfterBtn.textContent = '在下一行插入';
                insertAfterBtn.onclick = () => {
                    addUsageRow('after', cell);
                };

                const deleteRowBtn = document.createElement('button');
                deleteRowBtn.className = 'insert-btn';
                deleteRowBtn.textContent = '删除当前行';
                deleteRowBtn.onclick = () => {
                    const row = cell.parentNode;
                    const tableBody = document.getElementById('usage-table-body');
                    // 确保至少保留一行
                    if (tableBody.rows.length > 1) {
                        tableBody.removeChild(row);
                    } else {
                        alert('至少需要保留一行！');
                    }
                };

                const contextMenu = document.createElement('div');
                contextMenu.style.position = 'absolute';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                contextMenu.style.backgroundColor = 'white';
                contextMenu.style.border = '1px solid #ddd';
                contextMenu.style.padding = '5px';
                contextMenu.style.zIndex = '1000';
                contextMenu.appendChild(insertAfterBtn);
                contextMenu.appendChild(deleteRowBtn);

                document.body.appendChild(contextMenu);

                const removeMenu = () => {
                    if (document.body.contains(contextMenu)) {
                        document.body.removeChild(contextMenu);
                    }
                    document.removeEventListener('click', removeMenu);
                };

                document.addEventListener('click', removeMenu);
            }
        });

        // 添加积分使用记录表格行的函数
        function addUsageRow(position = 'after', selectedCell = null) {
            const tableBody = document.getElementById('usage-table-body');
            let newRow;

            if (selectedCell) {
                const selectedRow = selectedCell.parentNode;
                const rowIndex = Array.from(tableBody.rows).indexOf(selectedRow);
                newRow = tableBody.insertRow(position === 'before' ? rowIndex : rowIndex + 1);
            } else {
                newRow = tableBody.insertRow();
            }

            // 创建三个可编辑单元格
            for (let i = 0; i < 3; i++) {
                const cell = newRow.insertCell(i);
                cell.contentEditable = true;
                cell.style.minHeight = '20px';
                cell.style.cursor = 'text';
                cell.textContent = '';
            }
        }

        // 排序函数
        function sortSummaryData(column, direction) {
            const sortedData = [...summaryDataCache].sort((a, b) => {
                let valueA, valueB;

                if (column === 'name') {
                    valueA = a.name.toLowerCase();
                    valueB = b.name.toLowerCase();
                } else if (column === 'score') {
                    valueA = parseInt(a.total_score);
                    valueB = parseInt(b.total_score);
                }

                if (direction === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            renderSummaryTable(sortedData);
            updateSortIndicators(column, direction);
        }

        // 渲染汇总表格
        function renderSummaryTable(data) {
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';

            data.forEach(item => {
                const newRow = summaryTableBody.insertRow();

                // 志愿者名字
                const nameCell = newRow.insertCell(0);
                nameCell.textContent = item.name;

                // 总积分
                const scoreCell = newRow.insertCell(1);
                scoreCell.textContent = item.total_score;

                // 已使用积分
                const usedScoreCell = newRow.insertCell(2);
                usedScoreCell.contentEditable = true;
                usedScoreCell.textContent = '0'; // 默认已使用积分为0

                // 已兑换课程数量
                const courseCountCell = newRow.insertCell(3);
                courseCountCell.textContent = '0'; // 默认已兑换课程数量为0

                // 剩余积分
                const remainingScoreCell = newRow.insertCell(4);
                remainingScoreCell.textContent = item.total_score; // 初始剩余积分等于总积分

                // 为已使用积分单元格添加输入事件监听器，自动计算剩余积分
                usedScoreCell.addEventListener('input', function() {
                    updateRemainingScore(newRow);
                });
            });
        }

        // 更新剩余积分的函数
        function updateRemainingScore(row) {
            const totalScore = parseInt(row.cells[1].textContent) || 0; // 总积分
            const usedScore = parseInt(row.cells[2].textContent) || 0;  // 已使用积分
            const remainingScore = totalScore - usedScore; // 计算剩余积分

            row.cells[4].textContent = remainingScore; // 更新剩余积分列
        }

        // 从数据库获取并同步积分使用情况到汇总表格
        function syncUsageDataFromDatabase() {
            fetch(`${API_BASE_URL}/api/get_usage_summary`, {
                method: 'GET',
            })
            .then(response => {
                // 检查响应状态
                if (!response.ok) {
                    throw new Error('获取积分使用情况失败: ' + response.status);
                }
                return response.json();
            })
            .then(usageData => {
                const summaryTableBody = document.getElementById('summary-table-body');
                const summaryRows = summaryTableBody.rows;

                // 遍历汇总表格的每一行
                for (let i = 0; i < summaryRows.length; i++) {
                    const summaryRow = summaryRows[i];
                    const volunteerName = summaryRow.cells[0].textContent.trim();

                    // 在使用数据中查找对应的志愿者
                    const usageRecord = usageData.find(record => record.name === volunteerName);
                    if (usageRecord) {
                        // 更新已使用积分列（显示累加后的结果）
                        summaryRow.cells[2].textContent = usageRecord.used_points || 0;

                        // 更新已兑换课程数量列（显示累加后的结果）
                        summaryRow.cells[3].textContent = usageRecord.course_count || 0;

                        // 重新计算剩余积分
                        updateRemainingScore(summaryRow);
                    }
                }
            })
            .catch(error => {
                // 改进错误处理
                console.error('获取积分使用情况失败:', error.message || '未知错误');
                // 不显示错误提示，保持表格现有数据
            });
        }

        // 更新排序指示器
        function updateSortIndicators(column, direction) {
            // 清除所有排序指示器
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // 添加当前排序指示器
            const targetHeader = document.getElementById('sort-' + column);
            if (targetHeader) {
                targetHeader.classList.add('sort-' + direction);
            }
        }

        // 加载汇总数据的函数
        function loadSummaryData() {
            fetch(`${API_BASE_URL}/api/get_summary`, {
                method: 'GET',
            })
            .then(response => {
                // 首先检查响应状态
                if (!response.ok) {
                    // 如果响应不是 2xx，抛出错误并包含状态码
                    throw new Error('服务器返回错误状态码: ' + response.status);
                }
                return response.json();
            })
            .then(summaryData => {
                summaryDataCache = summaryData; // 缓存数据用于排序
                renderSummaryTable(summaryData);

                // 加载积分使用情况数据
                syncUsageDataFromDatabase();
            })
            .catch(error => {
                // 改进错误处理，避免直接传递错误对象
                console.error('加载汇总数据失败:', error.message || '未知错误');
                // 显示用户友好的错误消息
                const summaryTableBody = document.getElementById('summary-table-body');
                if (summaryTableBody) {
                    const errorRow = summaryTableBody.insertRow();
                    const errorCell = errorRow.insertCell(0);
                    errorCell.colSpan = 5;
                    errorCell.textContent = '加载数据失败，请稍后再试';
                    errorCell.style.textAlign = 'center';
                    errorCell.style.color = 'red';
                }
            });
        }

        // 页面加载时初始化表格和汇总数据
        window.onload = function() {
            updateTable();
            loadSummaryData(); // 加载数据库中的汇总数据

            // 添加排序事件监听器
            document.getElementById('sort-name').addEventListener('click', function() {
                const newDirection = (currentSortColumn === 'name' && currentSortDirection === 'asc') ? 'desc' : 'asc';
                currentSortColumn = 'name';
                currentSortDirection = newDirection;
                sortSummaryData('name', newDirection);
            });

            document.getElementById('sort-score').addEventListener('click', function() {
                const newDirection = (currentSortColumn === 'score' && currentSortDirection === 'asc') ? 'desc' : 'asc';
                currentSortColumn = 'score';
                currentSortDirection = newDirection;
                sortSummaryData('score', newDirection);
            });
        };

        // 新增样式
        const style = document.createElement('style');
        style.textContent = `
            .action-btn {
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 16px;
                margin-right: 10px;
            }
            .action-btn:hover {
                background-color: #45a049;
            }
            .export-btn {
                background-color: #2196F3;
            }
            .export-btn:hover {
                background-color: #1976D2;
            }
        `;
        document.head.appendChild(style);

        // 提交按钮点击事件（修改后，移除提示窗口）
        // 新增清空按钮点击事件
        document.getElementById('clear-btn').addEventListener('click', function() {
            // 清空第一个表格
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // 清空表格内容
            const activityType = document.getElementById('activity-type').value;
            updateTable(); // 重新初始化表格

            // 清空第二个表格（积分使用记录表格）
            const usageTableBody = document.getElementById('usage-table-body');
            usageTableBody.innerHTML = '';

            // 重新添加一个空白行
            const newRow = usageTableBody.insertRow();
            for (let i = 0; i < 3; i++) {
                const cell = newRow.insertCell(i);
                cell.contentEditable = true;
                cell.style.minHeight = '20px';
                cell.style.cursor = 'text';
                cell.textContent = '';
            }
        });

        // 导出活动总览表按钮点击事件
        document.getElementById('export-activity-btn').addEventListener('click', function() {
            const exportBtn = document.getElementById('export-activity-btn');
            const originalText = exportBtn.textContent;

            // 显示加载状态
            exportBtn.textContent = '导出中...';
            exportBtn.disabled = true;

            // 调用后端导出接口
            fetch(`${API_BASE_URL}/api/export_db`, {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('导出失败');
                }
                return response.blob();
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'volunteer_activity_overview_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('活动总览表导出成功！文件已下载到本地。');
            })
            .catch(error => {
                console.error('导出失败:', error);
                alert('导出失败，请检查网络连接或联系管理员');
            })
            .finally(() => {
                // 恢复按钮状态
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            });
        });

        // 导出志愿者积分总表按钮点击事件
        document.getElementById('export-summary-btn').addEventListener('click', function() {
            const exportBtn = document.getElementById('export-summary-btn');
            const originalText = exportBtn.textContent;

            // 显示加载状态
            exportBtn.textContent = '导出中...';
            exportBtn.disabled = true;

            // 调用后端导出志愿者积分总表接口
            fetch(`${API_BASE_URL}/api/export_volunteer_summary`, {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('导出失败');
                }
                return response.blob();
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'volunteer_points_summary_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                alert('志愿者积分总表导出成功！文件已下载到本地。');
            })
            .catch(error => {
                console.error('导出失败:', error);
                alert('导出失败，请检查网络连接或联系管理员');
            })
            .finally(() => {
                // 恢复按钮状态
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            });
        });

        // 提交按钮点击事件（修改后，合并重复名字并累加积分，并提交到后端）
        document.getElementById('submit-btn').addEventListener('click', function() {
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;

            // 显示加载状态
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;

            // 获取活动时间与名称
            const mergedCell = document.querySelector('#table-body tr:first-child td[rowspan]');

            // 收集活动数据（第一个表格）
            const activityData = [];
            const rows = document.getElementById('table-body').rows;
            const activityTimeName = mergedCell ? mergedCell.textContent.trim() : '';
            const activityTypeValue = document.getElementById('activity-type').value; // 获取活动类型值

            // 将英文值转换为中文
            const activityType = activityTypeValue === 'offline' ? '线下活动' : '线上直播';

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];

                // 现在所有行都有4个单元格：[活动时间(第一行可见，其他行隐藏), 类别, 名字, 积分]
                if (row.cells.length === 4) {
                    const categorySelect = row.cells[1].querySelector('select');
                    const category = categorySelect ? categorySelect.value : '';
                    const name = row.cells[2].textContent.trim();
                    const score = row.cells[3].textContent.trim();

                    if (name && score && category) {
                        const scoreValue = parseInt(score, 10);
                        if (!isNaN(scoreValue)) {
                            // 新格式：[activity_type, activity_time_name, category, name, score]
                            activityData.push([activityType, activityTimeName, category, name, scoreValue.toString()]);
                        }
                    }
                } else {
                    // 跳过无效行
                    continue;
                }
            }

            // 收集积分使用数据（第二个表格）
            const usageData = [];
            const usageRows = document.getElementById('usage-table-body').rows;

            for (let i = 0; i < usageRows.length; i++) {
                const row = usageRows[i];
                if (row.cells.length === 3) {
                    const name = row.cells[0].textContent.trim();
                    const usedPoints = row.cells[1].textContent.trim();
                    const courseCount = row.cells[2].textContent.trim();

                    if (name && usedPoints && courseCount) {
                        usageData.push([name, usedPoints, courseCount]);
                    }
                }
            }

            if (activityData.length === 0 && usageData.length === 0) {
                alert('请先输入数据！');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }

            // 发送数据到后端
            fetch(`${API_BASE_URL}/api/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    activityData: activityData,
                    usageData: usageData
                })
            })
            .then(response => {
                // 首先检查响应状态
                if (!response.ok) {
                    // 如果响应不是 2xx，抛出错误并包含状态码
                    throw new Error('服务器返回错误状态码: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    alert(data.message);
                }

                // 提交成功后，从数据库获取汇总数据
                return fetch(`${API_BASE_URL}/api/get_summary`, {
                    method: 'GET',
                });
            })
            .then(response => {
                // 检查响应状态
                if (!response.ok) {
                    throw new Error('获取汇总数据失败: ' + response.status);
                }
                return response.json();
            })
            .then(summaryData => {
                summaryDataCache = summaryData; // 更新缓存数据
                renderSummaryTable(summaryData);

                // 从数据库获取累加后的积分使用情况并同步到汇总表格
                syncUsageDataFromDatabase();

                // 如果之前有排序，保持排序状态
                if (currentSortColumn) {
                    sortSummaryData(currentSortColumn, currentSortDirection);
                }
            })
            .catch(error => {
                // 改进错误处理，避免直接传递错误对象
                console.error('提交失败:', error.message || '未知错误');
                alert('提交失败，请检查网络连接或联系管理员');
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // 积分情况查询按钮点击事件
        document.getElementById('query-btn').addEventListener('click', function() {
            document.getElementById('query-modal').style.display = 'flex';
            document.getElementById('volunteer-name-input').value = '';
            document.getElementById('volunteer-name-input').focus();
        });

        // 取消查询按钮点击事件
        document.getElementById('cancel-query-btn').addEventListener('click', function() {
            document.getElementById('query-modal').style.display = 'none';
        });

        // 确认查询按钮点击事件
        document.getElementById('confirm-query-btn').addEventListener('click', function() {
            const volunteerName = document.getElementById('volunteer-name-input').value.trim();

            if (!volunteerName) {
                alert('请输入志愿者名字！');
                return;
            }

            // 在汇总表格中查找志愿者信息
            const summaryTableBody = document.getElementById('summary-table-body');
            const summaryRows = summaryTableBody.rows;
            let foundVolunteer = null;

            for (let i = 0; i < summaryRows.length; i++) {
                const row = summaryRows[i];
                const name = row.cells[0].textContent.trim();

                if (name === volunteerName) {
                    foundVolunteer = {
                        name: name,
                        totalScore: row.cells[1].textContent.trim(),
                        usedScore: row.cells[2].textContent.trim(),
                        courseCount: row.cells[3].textContent.trim(),
                        remainingScore: row.cells[4].textContent.trim()
                    };
                    break;
                }
            }

            // 显示查询结果
            showQueryResult(foundVolunteer);

            // 关闭查询弹窗
            document.getElementById('query-modal').style.display = 'none';
        });

        // 显示查询结果的函数
        function showQueryResult(volunteer) {
            const resultContent = document.getElementById('query-result-content');

            if (volunteer) {
                resultContent.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">志愿者名字：</span>${volunteer.name}
                    </div>
                    <div class="result-item">
                        <span class="result-label">总积分：</span>${volunteer.totalScore}
                    </div>
                    <div class="result-item">
                        <span class="result-label">已使用积分：</span>${volunteer.usedScore}
                    </div>
                    <div class="result-item">
                        <span class="result-label">已兑换课程数量：</span>${volunteer.courseCount}
                    </div>
                    <div class="result-item">
                        <span class="result-label">剩余积分：</span>${volunteer.remainingScore}
                    </div>
                `;
            } else {
                resultContent.innerHTML = `
                    <div class="result-item" style="text-align: center; color: #f44336;">
                        未找到该志愿者的积分信息，请检查名字是否正确。
                    </div>
                `;
            }

            document.getElementById('result-modal').style.display = 'flex';
        }

        // 关闭查询结果弹窗
        document.getElementById('close-result-btn').addEventListener('click', function() {
            document.getElementById('result-modal').style.display = 'none';
        });

        // 点击弹窗背景关闭弹窗
        document.getElementById('query-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('result-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // 支持回车键确认查询
        document.getElementById('volunteer-name-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('confirm-query-btn').click();
            }
        });


    </script>
</body>
</html>
